<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DPI - Portal Manager</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <div class="logo-frame" id="logo-frame" style="display:none">
            <img src="/logo.png" alt="Logo" class="company-logo" id="company-logo">
          </div>
          <div class="logo-text">
            <h1>Portal Manager</h1>
            <small>Gestione Aziendale</small>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" id="main-nav"></nav>
      <div class="sidebar-user">
        <div class="user-name" id="user-name"></div>
        <div class="user-role" id="user-role"></div>
        <button class="btn-logout" onclick="Auth.logout()"><span class="icon" style="width:16px;height:16px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></span> Esci</button>
      </div>
    </aside>
    <div class="sidebar-overlay" id="overlay" onclick="toggleMenu()"></div>
    
    <main class="main-content">
      <header class="topbar">
        <button class="menu-toggle" onclick="toggleMenu()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></button>
        <div class="topbar-left">
          <h2>Gestione DPI</h2>
          <p>Dispositivi di Protezione Individuale</p>
        </div>
        <div></div>
      </header>
      
      <div class="container">
        <!-- Tabs -->
        <div class="tabs" style="margin-bottom:20px">
          <button class="tab active" onclick="showTab('assegnazioni')">Assegnazioni</button>
          <button class="tab" onclick="showTab('catalogo')" id="tab-catalogo">Catalogo DPI</button>
          <button class="tab" onclick="showTab('gestione')" id="tab-gestione">Gestione Avanzata</button>
        </div>
        
        <!-- Tab Assegnazioni -->
        <div id="panel-assegnazioni">
          <div class="grid grid-2">
            <!-- Lista Assegnazioni -->
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                <h3 style="margin:0">DPI Assegnati</h3>
                <select id="filter-user" style="min-width:180px">
                  <option value="">Tutti i dipendenti</option>
                </select>
              </div>
              
              <div id="assegnazioni-list"></div>
            </div>
            
            <!-- Form Assegnazione (solo manager/admin) -->
            <div class="card" id="form-card">
              <h3>Nuova Assegnazione</h3>
              <div id="alert" class="alert hidden"></div>
              
              <form id="assign-form">
                <div class="form-group">
                  <label>Dipendente</label>
                  <select name="user_id" id="select-user" required>
                    <option value="">Seleziona dipendente...</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>DPI</label>
                  <select name="dpi_id" id="select-dpi" required onchange="updateTaglie()">
                    <option value="">Seleziona DPI...</option>
                  </select>
                </div>
                
                <div class="row row-2">
                  <div class="form-group">
                    <label>Taglia</label>
                    <select name="taglia" id="select-taglia">
                      <option value="">-</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>QuantitÃ </label>
                    <input type="number" name="quantita" value="1" min="1">
                  </div>
                </div>
                
                <div class="row row-2">
                  <div class="form-group">
                    <label>Data Consegna</label>
                    <input type="date" name="data_consegna" required>
                  </div>
                  <div class="form-group">
                    <label>Scadenza (opz.)</label>
                    <input type="date" name="data_scadenza">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Note</label>
                  <textarea name="note" placeholder="Note aggiuntive..."></textarea>
                </div>
                
                <button type="submit">Assegna DPI</button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Tab Catalogo (solo manager/admin) -->
        <div id="panel-catalogo" class="hidden">
          <div class="grid grid-2">
            <!-- Lista Catalogo -->
            <div class="card">
              <h3>Catalogo DPI Disponibili</h3>
              <div id="catalogo-list"></div>
            </div>
            
            <!-- Form Nuovo DPI -->
            <div class="card">
              <h3>Aggiungi DPI al Catalogo</h3>
              <div id="alert-cat" class="alert hidden"></div>
              
              <form id="catalogo-form">
                <div class="form-group">
                  <label>Nome DPI</label>
                  <input type="text" name="nome" required placeholder="es. Guanti antitaglio">
                </div>
                
                <div class="form-group">
                  <label>Categoria</label>
                  <select name="categoria" required>
                    <option value="">Seleziona categoria...</option>
                    <option value="Protezione testa">Protezione testa</option>
                    <option value="Protezione occhi">Protezione occhi</option>
                    <option value="Protezione udito">Protezione udito</option>
                    <option value="Protezione vie respiratorie">Protezione vie respiratorie</option>
                    <option value="Protezione mani">Protezione mani</option>
                    <option value="Protezione piedi">Protezione piedi</option>
                    <option value="Protezione anticaduta">Protezione anticaduta</option>
                    <option value="VisibilitÃ ">VisibilitÃ </option>
                    <option value="Protezione corpo">Protezione corpo</option>
                    <option value="Altro">Altro</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>Descrizione</label>
                  <textarea name="descrizione" placeholder="Descrizione, normativa, specifiche..."></textarea>
                </div>
                
                <div class="form-group">
                  <label>Taglie Disponibili</label>
                  <input type="text" name="taglia_disponibili" placeholder="es. S,M,L,XL oppure 38,39,40,41" value="Unica">
                  <small style="color:var(--text-muted)">Separa le taglie con virgola</small>
                </div>
                
                <div class="form-group">
                  <label>Codice a Barre (opzionale)</label>
                  <input type="text" name="codice_barre" placeholder="es. 1234567890123">
                  <small style="color:var(--text-muted)">Codice identificativo univoco</small>
                </div>
                
                <button type="submit">Aggiungi al Catalogo</button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Tab Gestione Avanzata (solo admin/manager) -->
        <div id="panel-gestione" class="hidden">
          <div class="grid grid-2">
            <!-- Import/Export -->
            <div class="card">
              <h3>Import/Export Catalogo</h3>
              <div id="alert-import" class="alert hidden"></div>
              
              <div style="margin-bottom:20px">
                <h4 style="margin-bottom:10px">Export Catalogo DPI</h4>
                <p style="color:var(--text-muted);font-size:13px;margin-bottom:12px">
                  Scarica il catalogo DPI completo con tutte le assegnazioni
                </p>
                <button onclick="exportDPI()" class="btn-secondary">
                  ðŸ“¥ Esporta Catalogo
                </button>
              </div>
              
              <div>
                <h4 style="margin-bottom:10px">Import Catalogo DPI</h4>
                <p style="color:var(--text-muted);font-size:13px;margin-bottom:12px">
                  Importa DPI da file JSON (solo nuovi elementi)
                </p>
                <input type="file" id="import-file" accept=".json" style="margin-bottom:10px">
                <button onclick="importDPI()" class="btn-primary">
                  ðŸ“¤ Importa Catalogo
                </button>
              </div>
            </div>
            
            <!-- Modifica DPI -->
            <div class="card">
              <h3>Modifica DPI Esistente</h3>
              <div id="alert-edit" class="alert hidden"></div>
              
              <form id="edit-form" style="display:none">
                <input type="hidden" name="edit_id">
                
                <div class="form-group">
                  <label>Nome DPI</label>
                  <input type="text" name="edit_nome" required>
                </div>
                
                <div class="form-group">
                  <label>Categoria</label>
                  <select name="edit_categoria" required>
                    <option value="Protezione testa">Protezione testa</option>
                    <option value="Protezione occhi">Protezione occhi</option>
                    <option value="Protezione udito">Protezione udito</option>
                    <option value="Protezione vie respiratorie">Protezione vie respiratorie</option>
                    <option value="Protezione mani">Protezione mani</option>
                    <option value="Protezione piedi">Protezione piedi</option>
                    <option value="Protezione anticaduta">Protezione anticaduta</option>
                    <option value="VisibilitÃ ">VisibilitÃ </option>
                    <option value="Protezione corpo">Protezione corpo</option>
                    <option value="Altro">Altro</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label>Descrizione</label>
                  <textarea name="edit_descrizione"></textarea>
                </div>
                
                <div class="form-group">
                  <label>Taglie Disponibili</label>
                  <input type="text" name="edit_taglia_disponibili">
                </div>
                
                <div class="form-group">
                  <label>Codice a Barre</label>
                  <input type="text" name="edit_codice_barre">
                </div>
                
                <div style="display:flex;gap:10px">
                  <button type="submit">Salva Modifiche</button>
                  <button type="button" onclick="cancelEdit()" class="btn-secondary">Annulla</button>
                </div>
              </form>
              
              <div id="edit-instructions">
                <p style="color:var(--text-muted);text-align:center;padding:40px 20px">
                  Clicca su "Modifica" accanto a un DPI nel catalogo per modificarlo
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>initDPI();</script>
</body>
</html>
